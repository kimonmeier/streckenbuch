@page "/fahren"
@using Streckenbuch.Client.Components.Fahren
@using Streckenbuch.Client.Services
@inject FahrenService.FahrenServiceClient fahrenService
@inject IDialogService dialogService
@inject ScreenWakeLockService screenWakeLockService
@layout FahrenLayout
@implements IDisposable

<PageTitle>Fahren</PageTitle>

<FahrenTimeLine FahrplanEntries="List"></FahrenTimeLine>

@code {
    [CascadingParameter]
    public FahrenLayout Layout { get; set; } = null!;

    private List<IBaseEntry> List = new List<IBaseEntry>();
    private WakeLockSentinel? lockSentinel = null;

    protected async override Task OnInitializedAsync()
    {
        Layout.SelectRoute += SelectRoute;

        lockSentinel = await screenWakeLockService.RequestWakeLockAsync();
    }

    private void SelectRoute(object? source, EventArgs eventArgs)
    {
        Task.Run(async () =>
        {
            var dialog = dialogService.Show<LoadFahrordnung>();
            var result = await dialog.Result;

            if (result?.Data is not List<IBaseEntry> list)
            {
                throw new ArgumentException("Something is wrong");
            }

            List = list;
            await InvokeAsync(StateHasChanged);
        });
    }
    
    public void Dispose()
    {
        Layout.SelectRoute -= SelectRoute;

        if (lockSentinel is not null)
        {
            screenWakeLockService.ReleaseWakeLockAsync(lockSentinel).ConfigureAwait(false);
        }
    }
}
